// Prisma Schema for Field Force CRM
// Database: Neon PostgreSQL (serverless)
// Documentation: https://www.prisma.io/docs

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// DAY 1: Authentication Models
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String
  phone     String?
  role      UserRole @default(FIELD_REP)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  // Relations
  contacts  Contact[] // Contacts assigned to this user
  visits    Visit[]   // Visits conducted by this user

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([companyId])
}

model Company {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String?
  address     String?

  // Relations
  users       User[]
  contacts    Contact[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
}

enum UserRole {
  SUPER_ADMIN   // Platform admin
  ADMIN         // Company admin
  MANAGER       // Regional manager
  FIELD_REP     // Medical representative
}

// ============================================================================
// DAY 2: Contact Management
// ============================================================================

model Contact {
  id              String       @id @default(cuid())

  // Basic Information
  name            String
  designation     String?      // Dr., Pharmacist, Store Owner, etc.
  specialty       String?      // Cardiologist, Dermatologist, etc.
  contactType     ContactType  @default(DOCTOR)

  // Contact Details
  phone           String?
  email           String?
  alternatePhone  String?

  // Address Information
  address         String?
  city            String?
  state           String?
  pincode         String?

  // Professional Details
  hospitalName    String?
  clinicName      String?
  licenseNumber   String?

  // Visit Planning
  visitFrequency  VisitFrequency @default(MONTHLY)
  preferredDay    String?        // Monday, Tuesday, etc.
  preferredTime   String?        // Morning, Afternoon, Evening
  lastVisitDate   DateTime?
  nextVisitDate   DateTime?

  // Relationship
  assignedToId    String?
  assignedTo      User?        @relation(fields: [assignedToId], references: [id])
  companyId       String?
  company         Company?     @relation(fields: [companyId], references: [id])

  // Relations
  visits          Visit[]      // Visits to this contact

  // Additional Information
  notes           String?      // Special notes about the contact
  tags            String[]     @default([])

  // Status
  isActive        Boolean      @default(true)

  // Metadata
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Single column indexes
  @@index([assignedToId])
  @@index([companyId])
  @@index([contactType])
  @@index([city])
  @@index([isActive])

  // Composite indexes for common query patterns
  @@index([companyId, isActive, contactType])       // List active contacts by company and type
  @@index([assignedToId, isActive])                 // Field rep's active contacts
  @@index([companyId, contactType, isActive])       // Contacts by type within company (duplicate for clarity)
  @@index([city, contactType])                      // Geographic + type queries
  @@index([nextVisitDate, assignedToId])            // Visit planning queries
  @@index([isActive, createdAt])                    // Recent active contacts
}

enum ContactType {
  DOCTOR        // Medical practitioner
  PHARMACIST    // Pharmacy owner/staff
  RETAILER      // Medical store retailer
  HOSPITAL      // Hospital admin/procurement
  CLINIC        // Clinic contact
  OTHER         // Other contacts
}

enum VisitFrequency {
  DAILY
  WEEKLY
  BIWEEKLY      // Every 2 weeks
  MONTHLY
  QUARTERLY
  CUSTOM
}

// ============================================================================
// DAY 3: Visits & Activities
// ============================================================================

model Visit {
  id              String       @id @default(cuid())

  // Basic Information
  visitDate       DateTime     @default(now())
  visitType       VisitType    @default(FIELD_VISIT)
  status          VisitStatus  @default(COMPLETED)
  duration        Int?         // Duration in minutes

  // Contact & User
  contactId       String
  contact         Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  fieldRepId      String
  fieldRep        User         @relation(fields: [fieldRepId], references: [id])

  // GPS Location
  latitude        Float?
  longitude       Float?
  locationName    String?      // e.g., "Hospital Name" or "Clinic Address"

  // Visit Details
  purpose         String?      // Purpose of visit
  notes           String?      // Visit notes
  outcome         VisitOutcome @default(SUCCESSFUL)
  nextVisitDate   DateTime?    // Planned next visit

  // Products Discussed/Demonstrated
  products        String[]     @default([])  // Array of product names

  // Samples & Marketing Materials
  samplesGiven    Json?        // { "productName": quantity }
  marketingMaterials Json?     // Array of materials distributed

  // Follow-up
  followUpRequired Boolean     @default(false)
  followUpNotes   String?

  // Attachments (stored in R2)
  attachments     String[]     @default([])  // Array of R2 object keys
  photos          String[]     @default([])  // Photos from visit

  // Metadata
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Indexes for common queries
  @@index([contactId, visitDate])
  @@index([fieldRepId, visitDate])
  @@index([visitDate])
  @@index([status])
  @@index([fieldRepId, status, visitDate])  // Field rep's visits filtered by status
  @@index([contactId, status])              // Contact's visit history
}

enum VisitType {
  FIELD_VISIT      // Regular field visit
  FOLLOW_UP        // Follow-up visit
  EMERGENCY        // Emergency/urgent visit
  PLANNED          // Pre-scheduled visit
  COLD_CALL        // Unplanned visit
  VIRTUAL          // Virtual/phone call
  EVENT            // Event/conference meeting
}

enum VisitStatus {
  PLANNED          // Visit is scheduled
  IN_PROGRESS      // Visit is ongoing
  COMPLETED        // Visit completed
  CANCELLED        // Visit cancelled
  POSTPONED        // Visit postponed
  NO_SHOW          // Contact not available
}

enum VisitOutcome {
  SUCCESSFUL       // Successful visit
  PARTIAL          // Partially successful
  UNSUCCESSFUL     // Unsuccessful visit
  FOLLOW_UP_NEEDED // Needs follow-up
  ORDER_PLACED     // Order placed
  SAMPLE_GIVEN     // Samples provided
  INFORMATION_ONLY // Information sharing only
}

// ============================================================================
// DAY 4-5: Additional models will be added via migrations
// - Orders (product orders)
// - Payments (payment tracking)
// ============================================================================
